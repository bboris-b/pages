<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trascrittore Audio OPUS - Qualit√† Migliorata</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .info-box {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #0c5460;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }

        .model-selector {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .model-selector label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #856404;
        }

        .model-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .model-info {
            margin-top: 8px;
            font-size: 12px;
            color: #856404;
        }

        .loading-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .loading-section.active {
            display: block;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-area.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 14px;
            color: #666;
        }

        #fileInput {
            display: none;
        }

        .file-list {
            margin-top: 30px;
        }

        .file-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .file-name {
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .file-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #cfe2ff;
            color: #084298;
        }

        .status-success {
            background: #d1e7dd;
            color: #0f5132;
        }

        .status-error {
            background: #f8d7da;
            color: #842029;
        }

        .transcription {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .copy-btn {
            padding: 6px 15px;
            font-size: 12px;
            margin-left: 10px;
        }

        .error-msg {
            color: #842029;
            font-size: 13px;
            margin-top: 5px;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
        }

        .progress-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è Trascrittore Audio OPUS</h1>
        <p class="subtitle">100% Gratuito - Whisper AI locale nel browser</p>

        <div class="info-box">
            <strong>‚ú® Completamente gratuito e privato!</strong>
            Al primo utilizzo scaricher√† il modello Whisper. Tutto funziona localmente nel tuo browser, nessun dato viene inviato online.
        </div>

        <div class="model-selector">
            <label for="modelSelect">üéØ Seleziona Modello:</label>
            <select id="modelSelect">
                <option value="Xenova/whisper-tiny">Tiny - Veloce (~40MB) - Qualit√† Base</option>
                <option value="Xenova/whisper-base" selected>Base - Bilanciato (~140MB) - Qualit√† Buona ‚≠ê</option>
                <option value="Xenova/whisper-small">Small - Lento (~480MB) - Qualit√† Ottima</option>
            </select>
            <div class="model-info" id="modelInfo">
                üìä Base √® consigliato: buon compromesso tra velocit√† e accuratezza
            </div>
        </div>

        <div class="loading-section" id="loadingSection">
            <div class="loading-spinner"></div>
            <div id="loadingText">Caricamento del modello Whisper in corso...</div>
            <div style="font-size: 12px; margin-top: 10px; color: #666;">Questo pu√≤ richiedere alcuni minuti al primo avvio</div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Trascina i file qui o clicca per selezionare</div>
            <div class="upload-hint">Supporta file .opus (singoli o multipli)</div>
            <input type="file" id="fileInput" accept=".opus,audio/opus" multiple>
        </div>

        <div class="buttons">
            <button id="transcribeBtn" disabled>Trascrivi Tutti</button>
            <button id="clearBtn" class="btn-secondary">Pulisci Lista</button>
            <button id="exportBtn" class="btn-secondary">Esporta JSON</button>
        </div>

        <div class="file-list" id="fileList"></div>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

        // Configurazione
        env.allowLocalModels = false;
        env.allowRemoteModels = true;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const transcribeBtn = document.getElementById('transcribeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const exportBtn = document.getElementById('exportBtn');
        const loadingSection = document.getElementById('loadingSection');
        const loadingText = document.getElementById('loadingText');
        const modelSelect = document.getElementById('modelSelect');
        const modelInfo = document.getElementById('modelInfo');

        let files = [];
        let transcriber = null;
        let audioContext = null;
        let currentModel = 'Xenova/whisper-base';

        // Aggiorna info modello
        modelSelect.addEventListener('change', (e) => {
            const modelInfos = {
                'Xenova/whisper-tiny': '‚ö° Veloce ma meno accurato. Buono per test rapidi.',
                'Xenova/whisper-base': '‚≠ê Consigliato: ottimo compromesso qualit√†/velocit√†.',
                'Xenova/whisper-small': 'üéØ Massima qualit√† ma pi√π lento. Per audio difficili.'
            };
            modelInfo.textContent = modelInfos[e.target.value];
            
            if (transcriber) {
                alert('Cambiando modello dovrai ricaricare la pagina. Vuoi continuare?');
            }
        });

        // Inizializza il modello Whisper
        async function initWhisper() {
            try {
                currentModel = modelSelect.value;
                loadingSection.classList.add('active');
                uploadArea.classList.add('disabled');
                modelSelect.disabled = true;
                
                loadingText.textContent = `Caricamento del modello ${currentModel.split('/')[1]}...`;
                
                transcriber = await pipeline(
                    'automatic-speech-recognition',
                    currentModel,
                    { 
                        quantized: true,
                        progress_callback: (progress) => {
                            if (progress.status === 'downloading') {
                                const percent = Math.round((progress.loaded / progress.total) * 100);
                                loadingText.textContent = `Download modello: ${percent}%`;
                            } else if (progress.status === 'loading') {
                                loadingText.textContent = 'Inizializzazione modello...';
                            }
                        }
                    }
                );
                
                loadingSection.classList.remove('active');
                uploadArea.classList.remove('disabled');
                console.log('Whisper caricato con successo!');
            } catch (error) {
                console.error('Errore caricamento Whisper:', error);
                loadingText.textContent = `Errore: ${error.message}`;
                alert('Errore nel caricamento del modello. Ricarica la pagina.');
            }
        }

        // Inizializza all'avvio
        initWhisper();

        // Inizializza AudioContext
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Gestione drag & drop
        uploadArea.addEventListener('click', () => {
            if (!transcriber) {
                alert('Attendi il caricamento del modello...');
                return;
            }
            fileInput.click();
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (transcriber) {
                uploadArea.classList.add('dragover');
            }
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (!transcriber) {
                alert('Attendi il caricamento del modello...');
                return;
            }
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Gestisci file caricati
        function handleFiles(newFiles) {
            const opusFiles = Array.from(newFiles).filter(file => 
                file.name.toLowerCase().endsWith('.opus') || file.type === 'audio/opus'
            );

            if (opusFiles.length === 0) {
                alert('Seleziona almeno un file .opus');
                return;
            }

            opusFiles.forEach(file => {
                const fileId = Date.now() + Math.random();
                files.push({
                    id: fileId,
                    file: file,
                    status: 'pending',
                    transcription: '',
                    error: null
                });
                addFileToList(fileId, file.name, file.size);
            });

            transcribeBtn.disabled = false;
        }

        // Aggiungi file alla lista visuale
        function addFileToList(fileId, fileName, fileSize) {
            const sizeKB = (fileSize / 1024).toFixed(2);
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.id = `file-${fileId}`;
            fileItem.innerHTML = `
                <div class="file-header">
                    <span class="file-name">üìÑ ${fileName} <span style="color: #999; font-weight: normal;">(${sizeKB} KB)</span></span>
                    <span class="file-status status-pending">In attesa</span>
                </div>
                <div class="progress-bar" style="display: none;">
                    <div class="progress-fill"></div>
                </div>
            `;
            fileList.appendChild(fileItem);
        }

        // Aggiorna stato file
        function updateFileStatus(fileId, status, transcription = '', error = null, progress = 0) {
            const fileItem = document.getElementById(`file-${fileId}`);
            if (!fileItem) return;

            const statusEl = fileItem.querySelector('.file-status');
            const progressBar = fileItem.querySelector('.progress-bar');
            const progressFill = fileItem.querySelector('.progress-fill');

            const statusTexts = {
                pending: 'In attesa',
                processing: 'Elaborazione...',
                success: 'Completato ‚úì',
                error: 'Errore ‚úó'
            };

            statusEl.textContent = statusTexts[status];
            statusEl.className = `file-status status-${status}`;

            // Mostra progress bar durante elaborazione
            if (status === 'processing') {
                progressBar.style.display = 'block';
                progressFill.style.width = `${progress}%`;
            } else {
                progressBar.style.display = 'none';
            }

            // Aggiorna l'oggetto file
            const fileObj = files.find(f => f.id === fileId);
            if (fileObj) {
                fileObj.status = status;
                fileObj.transcription = transcription;
                fileObj.error = error;
            }

            // Rimuovi contenuti precedenti
            const existingContent = fileItem.querySelector('.transcription, .error-msg');
            if (existingContent) existingContent.remove();

            if (status === 'success' && transcription) {
                const transcriptionDiv = document.createElement('div');
                transcriptionDiv.className = 'transcription';
                transcriptionDiv.textContent = transcription;
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copia';
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(transcription);
                    copyBtn.textContent = 'Copiato!';
                    setTimeout(() => copyBtn.textContent = 'Copia', 2000);
                };
                
                fileItem.appendChild(transcriptionDiv);
                fileItem.querySelector('.file-header').appendChild(copyBtn);
            } else if (status === 'error' && error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-msg';
                errorDiv.textContent = `‚ùå ${error}`;
                fileItem.appendChild(errorDiv);
            }
        }

        // Normalizza audio per migliorare la qualit√†
        function normalizeAudio(audioData) {
            // Trova il massimo valore assoluto
            let maxAmp = 0;
            for (let i = 0; i < audioData.length; i++) {
                const abs = Math.abs(audioData[i]);
                if (abs > maxAmp) maxAmp = abs;
            }
            
            // Normalizza se necessario (evita clipping)
            if (maxAmp > 0 && maxAmp < 0.95) {
                const factor = 0.95 / maxAmp;
                const normalized = new Float32Array(audioData.length);
                for (let i = 0; i < audioData.length; i++) {
                    normalized[i] = audioData[i] * factor;
                }
                return normalized;
            }
            
            return audioData;
        }

        // Applica filtro passa-alto per ridurre rumori bassi
        function highPassFilter(audioData, sampleRate) {
            const cutoffFreq = 80; // Hz
            const RC = 1.0 / (cutoffFreq * 2 * Math.PI);
            const dt = 1.0 / sampleRate;
            const alpha = RC / (RC + dt);
            
            const filtered = new Float32Array(audioData.length);
            filtered[0] = audioData[0];
            
            for (let i = 1; i < audioData.length; i++) {
                filtered[i] = alpha * (filtered[i - 1] + audioData[i] - audioData[i - 1]);
            }
            
            return filtered;
        }

        // Converti audio file in array per Whisper
        async function audioFileToArray(file) {
            initAudioContext();
            
            const arrayBuffer = await file.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            // Converti in mono se necessario e ottieni i campioni
            let audioData;
            if (audioBuffer.numberOfChannels === 1) {
                audioData = audioBuffer.getChannelData(0);
            } else {
                // Mix stereo to mono
                const left = audioBuffer.getChannelData(0);
                const right = audioBuffer.getChannelData(1);
                audioData = new Float32Array(left.length);
                for (let i = 0; i < left.length; i++) {
                    audioData[i] = (left[i] + right[i]) / 2;
                }
            }
            
            // Ricampiona a 16kHz se necessario
            const targetSampleRate = 16000;
            if (audioBuffer.sampleRate !== targetSampleRate) {
                audioData = resampleAudio(audioData, audioBuffer.sampleRate, targetSampleRate);
            }
            
            // Applica miglioramenti audio
            audioData = highPassFilter(audioData, targetSampleRate);
            audioData = normalizeAudio(audioData);
            
            return audioData;
        }

        // Ricampionamento audio
        function resampleAudio(audioData, fromSampleRate, toSampleRate) {
            const ratio = fromSampleRate / toSampleRate;
            const newLength = Math.round(audioData.length / ratio);
            const result = new Float32Array(newLength);
            
            for (let i = 0; i < newLength; i++) {
                const srcIndex = i * ratio;
                const srcIndexFloor = Math.floor(srcIndex);
                const srcIndexCeil = Math.min(srcIndexFloor + 1, audioData.length - 1);
                const t = srcIndex - srcIndexFloor;
                
                result[i] = audioData[srcIndexFloor] * (1 - t) + audioData[srcIndexCeil] * t;
            }
            
            return result;
        }

        // Trascrivi con Whisper locale
        async function transcribeWithWhisper(fileId, audioData) {
            const output = await transcriber(audioData, {
                language: 'italian',
                task: 'transcribe',
                chunk_length_s: 30,
                stride_length_s: 5,
                return_timestamps: false,
                // Parametri aggiuntivi per migliorare la qualit√†
                temperature: [0.0, 0.2, 0.4, 0.6, 0.8, 1.0],
                compression_ratio_threshold: 2.4,
                logprob_threshold: -1.0,
                no_speech_threshold: 0.6
            });
            
            return output.text;
        }

        // Trascrivi tutti i file
        async function transcribeAll() {
            if (!transcriber) {
                alert('Il modello non √® ancora pronto. Attendi...');
                return;
            }

            transcribeBtn.disabled = true;
            
            for (const fileObj of files) {
                if (fileObj.status !== 'pending') continue;

                try {
                    updateFileStatus(fileObj.id, 'processing', '', null, 30);
                    
                    // Converti audio
                    const audioData = await audioFileToArray(fileObj.file);
                    updateFileStatus(fileObj.id, 'processing', '', null, 60);
                    
                    // Trascrivi
                    const transcription = await transcribeWithWhisper(fileObj.id, audioData);
                    updateFileStatus(fileObj.id, 'processing', '', null, 90);
                    
                    if (!transcription || transcription.trim() === '') {
                        throw new Error('Nessun testo trascritto - audio potrebbe essere silenzioso');
                    }
                    
                    updateFileStatus(fileObj.id, 'success', transcription.trim());
                } catch (error) {
                    console.error('Errore trascrizione:', error);
                    updateFileStatus(fileObj.id, 'error', '', error.message);
                }
            }

            transcribeBtn.disabled = false;
        }

        // Pulisci lista
        function clearList() {
            if (files.length > 0 && !confirm('Vuoi cancellare tutti i file caricati?')) {
                return;
            }
            files = [];
            fileList.innerHTML = '';
            transcribeBtn.disabled = true;
        }

        // Esporta JSON
        function exportJSON() {
            if (files.length === 0) {
                alert('Nessun file da esportare');
                return;
            }

            const results = files.map(f => ({
                filename: f.file.name,
                status: f.status,
                transcription: f.transcription,
                error: f.error,
                timestamp: new Date().toISOString()
            }));

            const dataStr = JSON.stringify(results, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trascrizioni_${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Event listeners
        transcribeBtn.addEventListener('click', transcribeAll);
        clearBtn.addEventListener('click', clearList);
        exportBtn.addEventListener('click', exportJSON);
    </script>
</body>
</html>
