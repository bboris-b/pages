<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trascrittore Audio OPUS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 14px;
            color: #666;
        }

        #fileInput {
            display: none;
        }

        .file-list {
            margin-top: 30px;
        }

        .file-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .file-name {
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .file-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #cfe2ff;
            color: #084298;
        }

        .status-success {
            background: #d1e7dd;
            color: #0f5132;
        }

        .status-error {
            background: #f8d7da;
            color: #842029;
        }

        .transcription {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .progress-bar {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .copy-btn {
            padding: 6px 15px;
            font-size: 12px;
            margin-left: 10px;
        }

        .error-msg {
            color: #842029;
            font-size: 13px;
            margin-top: 5px;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #856404;
        }

        .warning-box strong {
            display: block;
            margin-bottom: 5px;
        }

        .audio-duration {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è Trascrittore Audio OPUS</h1>
        <p class="subtitle">Carica file .opus per trascriverli automaticamente in testo</p>

        <div class="warning-box">
            <strong>‚ö†Ô∏è Requisiti:</strong>
            Usa Chrome o Edge. Richiede connessione internet per la trascrizione.
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Trascina i file qui o clicca per selezionare</div>
            <div class="upload-hint">Supporta file .opus (singoli o multipli)</div>
            <input type="file" id="fileInput" accept=".opus,audio/opus" multiple>
        </div>

        <div class="buttons">
            <button id="transcribeBtn" disabled>Trascrivi Tutti</button>
            <button id="clearBtn" class="btn-secondary">Pulisci Lista</button>
            <button id="exportBtn" class="btn-secondary">Esporta JSON</button>
        </div>

        <div class="file-list" id="fileList"></div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const transcribeBtn = document.getElementById('transcribeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const exportBtn = document.getElementById('exportBtn');

        let files = [];
        let audioContext = null;

        // Verifica supporto browser
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('‚ö†Ô∏è Il tuo browser non supporta la trascrizione vocale. Usa Chrome o Edge.');
        }

        // Inizializza AudioContext
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Gestione drag & drop
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Gestisci file caricati
        function handleFiles(newFiles) {
            const opusFiles = Array.from(newFiles).filter(file => 
                file.name.toLowerCase().endsWith('.opus') || file.type === 'audio/opus'
            );

            if (opusFiles.length === 0) {
                alert('Seleziona almeno un file .opus');
                return;
            }

            opusFiles.forEach(file => {
                const fileId = Date.now() + Math.random();
                files.push({
                    id: fileId,
                    file: file,
                    status: 'pending',
                    transcription: '',
                    error: null
                });
                addFileToList(fileId, file.name, file.size);
            });

            transcribeBtn.disabled = false;
        }

        // Aggiungi file alla lista visuale
        function addFileToList(fileId, fileName, fileSize) {
            const sizeKB = (fileSize / 1024).toFixed(2);
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.id = `file-${fileId}`;
            fileItem.innerHTML = `
                <div class="file-header">
                    <span class="file-name">üìÑ ${fileName} <span style="color: #999; font-weight: normal;">(${sizeKB} KB)</span></span>
                    <span class="file-status status-pending">In attesa</span>
                </div>
            `;
            fileList.appendChild(fileItem);
        }

        // Aggiorna stato file
        function updateFileStatus(fileId, status, transcription = '', error = null) {
            const fileItem = document.getElementById(`file-${fileId}`);
            if (!fileItem) return;

            const statusEl = fileItem.querySelector('.file-status');
            const statusTexts = {
                pending: 'In attesa',
                processing: 'Elaborazione...',
                success: 'Completato ‚úì',
                error: 'Errore ‚úó'
            };

            statusEl.textContent = statusTexts[status];
            statusEl.className = `file-status status-${status}`;

            // Aggiorna l'oggetto file
            const fileObj = files.find(f => f.id === fileId);
            if (fileObj) {
                fileObj.status = status;
                fileObj.transcription = transcription;
                fileObj.error = error;
            }

            // Rimuovi contenuti precedenti
            const existingContent = fileItem.querySelector('.transcription, .error-msg');
            if (existingContent) existingContent.remove();

            if (status === 'success' && transcription) {
                const transcriptionDiv = document.createElement('div');
                transcriptionDiv.className = 'transcription';
                transcriptionDiv.textContent = transcription;
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copia';
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(transcription);
                    copyBtn.textContent = 'Copiato!';
                    setTimeout(() => copyBtn.textContent = 'Copia', 2000);
                };
                
                fileItem.appendChild(transcriptionDiv);
                fileItem.querySelector('.file-header').appendChild(copyBtn);
            } else if (status === 'error' && error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-msg';
                errorDiv.textContent = `‚ùå ${error}`;
                fileItem.appendChild(errorDiv);
            }
        }

        // Converti OPUS in formato utilizzabile
        async function processAudioFile(file) {
            initAudioContext();
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                return audioBuffer;
            } catch (error) {
                throw new Error(`Impossibile decodificare l'audio: ${error.message}`);
            }
        }

        // Trascrivi usando Web Speech API con audio registrato
        async function transcribeAudio(fileId, audioBuffer) {
            return new Promise((resolve, reject) => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    reject(new Error('Web Speech API non supportata'));
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                
                recognition.lang = 'it-IT';
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                let transcript = '';
                let isRecognizing = false;

                recognition.onstart = () => {
                    isRecognizing = true;
                    console.log('Riconoscimento avviato');
                };

                recognition.onresult = (event) => {
                    console.log('Risultato ricevuto');
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            transcript += event.results[i][0].transcript + ' ';
                        }
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Errore riconoscimento:', event.error);
                    let errorMsg = 'Errore sconosciuto';
                    
                    switch(event.error) {
                        case 'no-speech':
                            errorMsg = 'Nessun parlato rilevato nell\'audio';
                            break;
                        case 'network':
                            errorMsg = 'Errore di rete - verifica la connessione internet';
                            break;
                        case 'not-allowed':
                            errorMsg = 'Microfono non autorizzato';
                            break;
                        case 'service-not-allowed':
                            errorMsg = 'Servizio di trascrizione non disponibile';
                            break;
                        case 'audio-capture':
                            errorMsg = 'Impossibile catturare l\'audio';
                            break;
                        default:
                            errorMsg = `Errore: ${event.error}`;
                    }
                    
                    reject(new Error(errorMsg));
                };

                recognition.onend = () => {
                    console.log('Riconoscimento terminato');
                    isRecognizing = false;
                    
                    if (transcript.trim()) {
                        resolve(transcript.trim());
                    } else {
                        reject(new Error('Nessun testo trascritto - l\'audio potrebbe essere troppo corto o senza parlato'));
                    }
                };

                // Crea un elemento audio per riprodurre (senza far partire l'audio realmente)
                // e avviare il riconoscimento
                try {
                    // Crea MediaStreamDestination
                    const destination = audioContext.createMediaStreamDestination();
                    const source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(destination);
                    
                    // NON collegare al output per evitare che l'audio parta
                    // source.connect(audioContext.destination);
                    
                    // Avvia riconoscimento prima di far partire l'audio
                    recognition.start();
                    
                    // Fai partire l'audio SOLO attraverso il MediaStream (non agli speaker)
                    source.start(0);
                    
                    // Ferma il riconoscimento quando l'audio finisce
                    source.onended = () => {
                        setTimeout(() => {
                            if (isRecognizing) {
                                recognition.stop();
                            }
                        }, 1000); // Attendi 1 secondo per eventuali risultati finali
                    };
                    
                } catch (error) {
                    reject(new Error(`Errore nell'elaborazione audio: ${error.message}`));
                }
            });
        }

        // Trascrivi tutti i file
        async function transcribeAll() {
            transcribeBtn.disabled = true;
            
            for (const fileObj of files) {
                if (fileObj.status !== 'pending') continue;

                updateFileStatus(fileObj.id, 'processing');

                try {
                    // Processa l'audio
                    const audioBuffer = await processAudioFile(fileObj.file);
                    
                    // Attendi un po' tra un file e l'altro per evitare problemi con l'API
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Trascrivi
                    const transcription = await transcribeAudio(fileObj.id, audioBuffer);
                    
                    updateFileStatus(fileObj.id, 'success', transcription);
                } catch (error) {
                    console.error('Errore trascrizione:', error);
                    updateFileStatus(fileObj.id, 'error', '', error.message);
                }
                
                // Pausa tra i file
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            transcribeBtn.disabled = false;
        }

        // Pulisci lista
        function clearList() {
            if (files.length > 0 && !confirm('Vuoi cancellare tutti i file caricati?')) {
                return;
            }
            files = [];
            fileList.innerHTML = '';
            transcribeBtn.disabled = true;
        }

        // Esporta JSON
        function exportJSON() {
            if (files.length === 0) {
                alert('Nessun file da esportare');
                return;
            }

            const results = files.map(f => ({
                filename: f.file.name,
                status: f.status,
                transcription: f.transcription,
                error: f.error,
                timestamp: new Date().toISOString()
            }));

            const dataStr = JSON.stringify(results, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trascrizioni_${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Event listeners
        transcribeBtn.addEventListener('click', transcribeAll);
        clearBtn.addEventListener('click', clearList);
        exportBtn.addEventListener('click', exportJSON);
    </script>
</body>
</html>
